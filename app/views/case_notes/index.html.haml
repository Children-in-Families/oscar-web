.row
  .col-xs-12
    .ibox
      .ibox-title
        %h5= "#{t('.case_note_lists')} #{@client.name}"
        .ibox-tools
          = link_to t('.back'), client_path(@client), { class: 'btn btn-default btn-back-default button' }
          - if can? :create, CaseNote
            - if enable_all_csi_tools?
              .btn-group#case-note-selection
                %button.btn.btn-primary.dropdown-toggle.btn-sm{ "aria-expanded" => "false", "aria-haspopup" => "true", "data-toggle" => "dropdown", :type => "button" }
                  = t('.new_case_note')
                  %span.caret
                %ul.dropdown-menu#case-note-dropdown
                  %li
                    = new_link
                  %li
                    - @custom_assessment_settings.each do |cs|
                      - if cs.domains.any?
                        = new_custom_link(cs.custom_assessment_name)
                      - else
                        = link_to '#', data: { toggle: 'modal', target: '#customDomainsModal' } do
                          = cs.custom_assessment_name

                #customDomainsModal.modal.fade{"aria-labelledby" => "customDomainsModalLabel", :role => "dialog", :tabindex => "-1"}
                  .modal-dialog{:role => "document"}
                    .modal-content.panel-warning
                      .modal-header.panel-heading
                        %button.btn-modal-cancel.close{ 'aria-hidden' => 'true', 'data-dismiss' => 'modal', type: 'button' } Ã—
                        %h4.text-left
                          %i.fa.fa-warning.fa-x2
                          = t('.no_custom_domains_available')
                      .modal-body.text-center
                        = t('.please_add_custom_domains')

            - elsif case_notes_editable? && policy(@client).create?
              = link_to t('.new_case_note'), new_client_case_note_path(@client, custom: @current_setting.enable_custom_assessment), class: 'btn btn-primary'

      .ibox-content
        - @case_notes.each do |case_note|
          .panel.panel-info
            .panel-heading
              .row
                .col-xs-8
                  %h3= display_case_note_attendee(case_note)
                  %p= "#{t('created_by')} #{whodunnit('CaseNote', case_note.id)} #{t('at')} #{date_format case_note.created_at}"
                .col-xs-4.text-right
                  %h4
                    = t('.case_note_on')
                    = date_format(case_note.meeting_date) if case_note.meeting_date
                    - if can? :manage, CaseNote
                      = edit_link(@client, case_note)
                    - if current_user.admin?
                      = destroy_link(@client, case_note)

            .panel-body
              - if case_note.note.present?
                .ibox.border-left-right.border-bottom
                  .ibox-content
                    .row
                      .col-xs-12
                        .panel.panel-default
                          .panel-heading
                            %h4= t('.note')
                          .panel-body
                            = simple_format case_note.note

              - case_note.case_note_domain_groups.each do |cdg|
                - list_goals = []
                - task_added = []
                - cdg.domains(case_note).each do |domain|
                  - task_added << case_note.client.tasks.where(domain_id: domain.id, relation: 'case_note', case_note_id: cdg.case_note_id)
                  - assessment_domain = domain.assessment_domains.find_by(assessment_id: case_note.assessment_id)
                  - if assessment_domain.present? && assessment_domain.goal?
                    - list_goals << assessment_domain.goal
                - if cdg.note.present? || cdg.completed_tasks.any? || list_goals.present? || cdg.attachments.any? || task_added.flatten.present?
                  .ibox.border-left-right.border-bottom
                    .ibox-title
                      %h5= cdg.domain_identities
                      - if case_note.assessment_id.present?
                        .ibox-tools
                          - cdg.domains(case_note).each do |domain|
                            - ad = domain.assessment_domains.find_by(assessment_id: case_note.assessment_id)
                            - next if ad.nil?
                            %a.collapse-link
                              %label.margin-score.case-note-domain-score{ class: "label label-#{ad.score_color_class} label-lg", 'data-original-title': "#{simple_format(ad.score_definition)}", 'data-toggle': 'tooltip' }
                                = ad.score
                    .ibox-content
                      .row
                        - if cdg.note.present?
                          .col-xs-12
                            .panel.panel-default
                              .panel-heading
                                %h4= t('.note')
                              .panel-body
                                = simple_format cdg.note
                        - if cdg.completed_tasks.any?
                          .col-xs-12.col-sm-6
                            .panel.panel-default
                              .panel-heading
                                %h4= t('.completed_tasks')
                              .panel-body.no-padding
                                %ul.list-group
                                  - cdg.completed_tasks.each_with_index do |task, index|
                                    %li.list-group-item
                                      = "#{index + 1}. "
                                      = task.name
                        - if list_goals.present?
                          .col-xs-12.col-sm-6
                            %p
                              %strong= "#{t('.goal')} :"
                            %ul
                              - list_goals.flatten.each do |goal|
                                %li= goal
                      .row
                        - if task_added.flatten.present?
                          .col-xs-12.col-sm-6
                            %p
                              %strong Task Added
                      .row
                        - if cdg.attachments.any?
                          .col-xs-12.col-sm-6
                            .panel.panel-default
                              .panel-heading
                                %h4= t('.attachments')
                              .panel-body
                                = render 'attachment', cdg: cdg
      .ibox-footer
        .text-center
          = paginate @case_notes
